!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";var e=function(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}},t=function(e,t){void 0===t&&(t=500);var r=null;return function(){for(var o=[],n=arguments.length;n--;)o[n]=arguments[n];r&&clearTimeout(r),r=setTimeout(function(){e.apply(this,o)},t)}},r=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},o=function(e){return"[object Error]"===Object.prototype.toString.call(e)},n=function(e){var t,r,o,n=screen.width,i=screen.height,s=screen.pixelDepth,a=screen.colorDepth;this.browser=function(){var e="undefined"!=typeof window&&window.navigator.userAgent.toLowerCase(),t=e&&/msie|trident/.test(e),r=e&&e.indexOf("edge/")>0,o=e&&/chrome\/\d+/.test(e)&&!r,n=e&&(e.indexOf("opera")>-1||e.indexOf("opr")>-1),i=e&&e.indexOf("safari")>-1&&-1===e.indexOf("chrome"),s=e&&e.indexOf("mqqbrowser")>0,a=e&&e.indexOf("firefox")>-1,u=e&&e.indexOf("ucbrowser/")>0,c=e&&e.indexOf("baiduboxapp")>0,p=e&&e.indexOf("android")>0,f=e&&/iphone|ipad|ipod|ios/.test(e);if(t){new RegExp("MSIE (\\d+\\.\\d+);").test(e);var l=parseFloat(RegExp.$1);return-1!==e.indexOf("msie 6.0")?{tag:"IE",userAgent:e,version:"6"}:7===l?{tag:"IE",userAgent:e,version:"7"}:8===l?{tag:"IE",userAgent:e,version:"8"}:9===l?{tag:"IE",userAgent:e,version:"9"}:10===l?{tag:"IE",userAgent:e,version:"10"}:e.match(/rv:([\d.]+)\) like gecko/)?{tag:"IE",userAgent:e,version:"11"}:{tag:"IE",userAgent:e,version:"0"}}return c?{tag:"Baidu",userAgent:e,version:""}:s?{tag:"QQ",userAgent:e,version:""}:u?{tag:"UC",userAgent:e,version:""}:r?{tag:"Edge",userAgent:e,version:""}:a?{tag:"firefox",userAgent:e,version:e.substr(e.indexOf("firefox")+8,10).split(".")[0]}:n?{tag:"Opera",userAgent:e,version:""}:i?{tag:"Safari",userAgent:e,version:e.substr(e.indexOf("version")+8,10).split(".")[0]}:o?{tag:"Chrome",userAgent:e,version:e.substr(e.indexOf("chrome")+7,10).split(".")[0]}:p?{tag:"Android",userAgent:e,version:""}:f?{tag:"IOS",userAgent:e,version:""}:void 0}(),this.platform=(t=window.navigator.userAgent,r=window.navigator.platform,o="",~["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(r)?o="Mac OS":~["iPhone","iPad","iPod"].indexOf(r)?o="iOS":~["Win32","Win64","Windows","WinCE"].indexOf(r)?o="Windows":/Android/.test(t)?o="Android":!o&&/Linux/.test(r)&&(o="Linux"),o),this.project=e,this.version="1.2.1",this.screen={width:n,height:i,pixelDepth:s,colorDepth:a}},i=Object.assign({},{id:"",project:"",baseUrl:"//fe-monitor.iyunxiao.com/v2/monitor"},{urlTracker:!0,visibilityTracker:!1,visibilityPvTime:36e5},{sample:1,jsError:!0,apiError:!0,vueError:!0,httpError:!0,filters:[]},{reportTime:36e5,reportPvTime:6e4},{isCollectedPerformance:!0,maxTiming:1e3}),s={APIError:{response:"responseText",method:"method",code:"code"},"Script Error":{msg:"stack"},"Vue HandleError":{msg:"stack"},ResourceError:{element:"element"}},a=function(){var e=location.origin,t=location.pathname,r=location.href;this.url=r,this.path=e+t,this.time=new Date,this.user=window.user||""};a.prototype.pushToErrorQueue=function(){var e=this,t={"Vue HandleError":function(e,t){return e.vmName===t.vmName&&e.stack===t.stack&&e.url===t.url},ResourceError:function(e,t){return e.element===t.element&&e.source===t.source&&e.url===t.url},APIError:function(e,t){return JSON.stringify(e.desc)===JSON.stringify(t.desc)&&e.url===t.url},"Script Error":function(e,t){return e.stack===t.stack&&e.url===t.url}},o=e.type,n=a.errorFilters.filter(function(e){return e.type===o}).some(function(t){var n=s[t.type],i=!1;for(var a in n)if(n.hasOwnProperty(a)){var u=n[a],c="APIError"===o?e.desc[u]:e[u];if(!t[a])continue;if(!(r(t[a])?t[a]:new RegExp(t[a])).test(c)){i=!1;break}i=!0}return i});a.errorQueue.some(function(r){return t[r.type](r,e)})||n||a.errorQueue.push(e)},a.prototype.pushToPerformanceQueue=function(){a.performanceQueue.push(this)},a.prototype.pushToResourceQueue=function(){a.resourceQueue.push(this)},a.prototype.pushToPageViewQueue=function(e){void 0===e&&(e=1);a.pageViewQueue.push(Object.assign({},{track:e},this))},a.hasReportData=function(){for(var e of["errorQueue","performanceQueue","resourceQueue"])if(0!==a[e].length)return!0;return!1},a.getReportData=function(e){var t={},r=e?["baseData",e]:["baseData","errorQueue","performanceQueue","resourceQueue"];for(var o of r)t[o]=a[o];return t},a.clear=function(){for(var e of["errorQueue","performanceQueue","resourceQueue"])a[e].length=0},a.clearPv=function(){a.pageViewQueue.length=0},a.customOptions=i,a.baseData={},a.errorFilters=[],a.errorQueue=[],a.performanceQueue=[],a.resourceQueue=[],a.pageViewQueue=[],a.errorTimer={id:"",failedNum:0},a.pvTimer={id:"",failedNum:0};var u,c=function(e){function t(t,r,o,n){void 0===o&&(o=""),void 0===n&&(n={}),e.call(this),this.type=t,this.msg=r,this.desc=n,this.stack=o}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(a),p=function(e){function t(t,r,o,n,i){e.call(this,t,"Vue 捕获异常",r,{name:o.name,message:o.message}),this.vmName=function(e){if(e.$root===e)return"root";var t=e._isVue?e.$options&&e.$options.name||e.$options&&e.$options._componentTag:e.name;return(t?"component <"+t+">":"anonymous component")+(e._isVue&&e.$options&&e.$options.__file?" at "+(e.$options&&e.$options.__file):"")}(n),this.info=i}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(c),f=function(e){function t(t,r,o,n,i,s){e.call(this,"APIError","接口请求异常"),this.desc={message:"接口请求异常",code:t,api:r,params:o,response:n,responseText:i,method:s}}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(c),l=function(e){function t(t,r){e.call(this,"ResourceError","资源加载异常"),this.source=r.src,this.tagName=r.tagName,this.element=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(c),d=function(e){function t(t){e.call(this);var r=t.memory,o=t.navigation,n=t.timing,i=t.onresourcetimingbufferfull,s=t.timeOrigin;this.memory=r,this.navigation=o,this.timing=n,this.onresourcetimingbufferfull=i,this.timeOrigin=s,this.referrer=document.referrer.split("/")[2]||"未知"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(a),m=function(e){function t(t){e.call(this),this.timings=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(a),g="visible",h=!("object"!=typeof safari||!safari.pushNotification);function v(){O(),history.pushState&&window.addEventListener&&(history.pushState=e(history.pushState,w),history.replaceState=e(history.replaceState,w),window.addEventListener("popstate",w))}function y(){document.visibilityState&&(u=t(O,a.customOptions.visibilityPvTime),window.addEventListener("visibilitychange",b,!0),h&&addEventListener("beforeunload",O,!0))}function w(){var e="";setTimeout(function(){var t=location.pathname+location.search;e!==t&&(e=t,O())},0)}function O(e){(new a).pushToPageViewQueue(e)}function b(){document.visibilityState===g&&u(0)}function T(e){var t=e.method,r=e.baseUrl,o=e.data,n=e.contentType;return void 0===n&&(n="text/plain"),new Promise(function(e,i){var s=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");s.onerror=i,s.onreadystatechange=function(){if(4===s.readyState)if(s.status>=200&&s.status<400){var t=/application\/json/.test(s.getResponseHeader("content-type"))?JSON.parse(s.responseText):s.responseText;e(t)}else i(new Error("POST to "+r+" failed with status: "+s.status))},s.open(t,r),s.setRequestHeader("Content-Type",n+";charset=UTF-8"),s.send(o)})}function E(){var e=a.getReportData(),t=a.customOptions,r=t.baseUrl+"/"+t.id+"/add";return a.hasReportData()&&(void 0!==navigator.sendBeacon?navigator.sendBeacon(r,JSON.stringify(e)):T({method:"post",baseUrl:r,data:JSON.stringify(e)})),e}var S={getNavigationTiming:function(){return performance.getEntriesByType("navigation")[0]},getResourceTiming:function(e){if(void 0!==performance)if(performance.getEntriesByType){var t=performance.getEntriesByType("resource").filter(function(t,r){return t.responseEnd-t.startTime>=e}).slice(0,20);if(t.length)new m(t).pushToResourceQueue()}else console.log("浏览器不支持资源加载收集");else console.log("浏览器不支持performance API 无法收集")},collectData:function(){new d(performance).pushToPerformanceQueue()},init:function(e){var t,r=this;t=function(){r.collectData(),r.getResourceTiming(e)},window.requestIdleCallback?window.requestIdleCallback(function(e){t.call(null)}):setTimeout(function(e){t.call(null)},0)}};!function(){function t(e,t){window.onunload=function(){E()},a.errorTimer.id=setInterval(function(e){!function(){var e=JSON.parse(localStorage.getItem("_BOSS_monitor")),t=a.getReportData("errorQueue");e&&(t.errorQueue=t.errorQueue.concat(e.errorQueue));var r=a.customOptions,o=r.baseUrl+"/"+r.id+"/add";a.errorQueue.length&&T({method:"post",baseUrl:o,data:JSON.stringify(t)}).then(function(e){localStorage.removeItem("_BOSS_monitor")}).catch(function(e){a.errorTimer.failedNum++,a.errorTimer.failedNum>=3&&(clearInterval(a.errorTimer.id),console.info("心跳检测失败，已断开链接"));var r=t.errorQueue;try{localStorage.setItem("_BOSS_monitor",JSON.stringify({errorQueue:r}))}catch(e){(function(e){var t=!1;if(e)if(e.code)switch(e.code){case 22:t=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===e.name&&(t=!0)}else-2147024882===e.number&&(t=!0);return t})(e)&&localStorage.removeItem("_BOSS_monitor")}}).then(function(){a.clear()})}()},e),a.pvTimer.id=setInterval(function(e){var t,r,o,n;t=a.baseData,r=a.pageViewQueue,o=a.customOptions,n=o.baseUrl+"/"+o.id+"/add/pv",r.length&&T({method:"post",baseUrl:n,contentType:"application/json",data:JSON.stringify({baseData:t,pageViewQueue:r})}).then(function(e){a.clearPv()}).catch(function(e){console.error(e),a.pvTimer.failedNum++,a.pvTimer.failedNum>=3&&(clearInterval(a.pvTimer.id),console.info("PV心跳检测失败，已断开链接"))})},t)}function r(){return Math.random()<=a.customOptions.sample}function i(o){var i=o.baseUrl,u=o.id,p=i||a.customOptions.baseUrl;T({method:"get",baseUrl:p+"/"+u+"/config"}).then(function(e){var t;0===e.code&&e.data&&(t=e.data,Object.assign(a.customOptions,t))}).catch(function(e){console.error(e),a.customOptions.baseUrl=p,a.customOptions.id=u}).then(function(o){var i,u,p,d,m,g,h,v,y,w;i=a.customOptions,u=i.name,p=i.jsError,d=i.apiError,m=i.httpError,g=i.reportTime,h=i.reportPvTime,v=i.filters,console.info("%c monitor custom config: ","background-color: #1DAEF8; color: white",a.customOptions),w=new n(u),a.baseData=w,a.errorFilters=v,p&&(window.onerror=function(e,t,o,n,i){if(i&&i.stack){if(!r())return;var s=i.name,a=i.message;new c("Script Error","脚本错误",i.stack.toString(),{name:s,message:a}).pushToErrorQueue()}}),m&&window.addEventListener&&window.addEventListener("error",function(e){if(!e.message){if(!r())return;var t,o=(t=e.target?e.target:e.srcElement)&&t.outerHTML;o&&o.length>200&&(o=o.slice(0,200)),new l(o,t).pushToErrorQueue()}},!0),d&&(y="",XMLHttpRequest.prototype.open=e(XMLHttpRequest.prototype.open,function(e){y=e}),XMLHttpRequest.prototype.send=e(XMLHttpRequest.prototype.send,function(e){var t=this;this.addEventListener("readystatechange",function(o){4===t.readyState&&![200,204,304,0].includes(t.status)&&r()&&-1===t.responseURL.indexOf(a.customOptions.baseUrl)&&new f(t.status+" "+t.statusText,t.responseURL,e,t.response,t.responseText,y).pushToErrorQueue()},!1)})),t(g,h),"complete"===document.readyState?s():window.addEventListener("load",function(e){s()})})}function s(){var e=a.customOptions,t=e.vueError,n=e.isCollectedPerformance,i=e.urlTracker,s=e.visibilityTracker,u=e.maxTiming;t&&window.Vue&&(window.Vue.config.errorHandler=function(e,t,n){if(e&&o(e)&&r())try{new p(void 0!==n?"Vue HandleError":"Async Http",e.stack.toString(),e,t,n).pushToErrorQueue()}catch(e){console.warn("errorHandler has error:",e)}}),n&&S.init(u),i&&v(),s&&y()}window.newMonitor={init:function(e){localStorage.removeItem("_BOSS_monitor"),i(e),window.nm={sendData:E,getData:function(){return a.getReportData()}}}}}()});
